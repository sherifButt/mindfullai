# Entity-Relationship (ER) Diagram based on the Sequence Diagram

**Mermaid ER Diagram**

```mermaid
erDiagram
    USER ||--|{ DIAGRAM : creates
    USER ||--|{ INSTRUCTION : executes
    DIAGRAM ||--|{ DIAGRAM_INSTRUCTION : includes
    DIAGRAM_INSTRUCTION ||--|| INSTRUCTION : associated_with
    INSTRUCTION ||--|{ JOB : triggers
    JOB ||--|| INSTRUCTION : associated_with

    USER {
        int user_id
        string email
        string password
        string jwt
        datetime created_at
        datetime updated_at
    }
    DIAGRAM {
        int id
        string diagram_data
        string name
        string description
        datetime created_at
        datetime updated_at
        int created_by
    }
    INSTRUCTION {
        int id
        int diagram_id
        string node_id
        string type
        string name
        string description
        json parameters
        int priority
        datetime scheduled_time
        int retry_count
        int max_retry
        datetime created_at
        datetime updated_at
    }
    JOB {
        int job_id
        int instruction_id
        datetime trigger_time
        datetime created_at
        datetime updated_at
    }
    DIAGRAM_INSTRUCTION {
        int diagram_id
        string node_id
        string node_type
        json parameters
        datetime created_at
        datetime updated_at
    }
```

**Entities (Tables) Description**

1. `User`: This entity represents the users of the system. The attributes include `user_id`, `email`, `password`, `jwt` (JSON Web Token for authentication), `created_at`, and `updated_at`.

2. `Diagram`: This entity represents the diagrams created by users. It has attributes like `id`, `diagram_data`, `name`, `description`, `created_at`, `updated_at`, and `created_by`.

3. `Instruction`: This entity stores the instructions associated with each diagram. The attributes include `id`, `diagram_id`, `node_id`, `type`, `name`, `description`, `parameters`, `priority`, `scheduled_time`, `retry_count`, `max_retry`, `created_at`, and `updated_at`.

4. `Job`: This entity represents the jobs created for delayed or scheduled instructions. It has a `job_id`, an `instruction_id` to link the job to a specific instruction, a `trigger_time` which indicates when the job should be executed, and timestamps `created_at` and `updated_at`.

5. `Diagram_Instruction`: This junction table that represents the many-to-many relationship between the `Diagram` and `Instruction` tables. It contains `diagram_id`, `node_id`, `node_type`, and `parameters` as attributes, as well as `created_at` and `updated_at`.

Please note that this is a simplified ER diagram based on the sequence diagram and the tables you provided. Depending on the complexity and requirements of your actual system, you might need to add more entities, relationships, or attributes.

**Introduction**

The proposed database schema appears to cover the required functionalities and operations described in the sequence diagram. However, a few additional points could be considered.

1. **Mind Map Sharing:** In the sequence diagram, the user has the ability to share the mind map. This would involve having permissions and shared settings saved somewhere. We might need a table (e.g., `Shared_Mindmaps`) to keep track of these sharing permissions.

2. **Avatar:** The Avatar generated by the GPT-4 needs to be stored somewhere. This could be in the `User` table or in a separate `Avatar` table.

3. **Immediate Actions:** If immediate actions are to be executed and their outcomes tracked, a table to log these immediate actions could be useful.

4. **Users and JWTs:** Consideration on how to handle JWTs might be required. If they are to be invalidated or refreshed, a table may be required to handle this.

So, while the ER diagram mostly covers the actions represented in the sequence diagram, there are a few additional considerations based on the specific requirements of your application.

Here's an updated ER diagram including the above points:

**Mermaid ER Diagram**

```mermaid
erDiagram
    USER ||--|{ DIAGRAM : creates
    USER ||--|{ INSTRUCTION : executes
    DIAGRAM ||--|{ DIAGRAM_INSTRUCTION : includes
    DIAGRAM_INSTRUCTION ||--|| INSTRUCTION : associated_with
    INSTRUCTION ||--|{ JOB : triggers
    JOB ||--|| INSTRUCTION : associated_with
    USER ||--|| AVATAR : has
    DIAGRAM ||--|{ SHARED_MINDMAPS : has
    
    USER {
        int user_id
        string email
        string password
        string jwt
        datetime created_at
        datetime updated_at
    }
    DIAGRAM {
        int id
        string diagram_data
        string name
        string description
        datetime created_at
        datetime updated_at
        int created_by
    }
    INSTRUCTION {
        int id
        int diagram_id
        string node_id
        string type
        string name
        string description
        json parameters
        int priority
        datetime scheduled_time
        int retry_count
        int max_retry
        datetime created_at
        datetime updated_at
    }
    JOB {
        int job_id
        int instruction_id
        datetime trigger_time
        datetime created_at
        datetime updated_at
    }
    DIAGRAM_INSTRUCTION {
        int diagram_id
        string node_id
        string node_type
        json parameters
        datetime created_at
        datetime updated_at
    }
    AVATAR {
        int avatar_id
        int user_id
        string avatar_data
        datetime created_at
        datetime updated_at
    }
    SHARED_MINDMAPS {
        int id
        int diagram_id
        int shared_with_user_id
        datetime shared_at
    }
```

[dbdiagram link](https://dbdiagram.io/d/6487e789722eb77494da0e29)

<iframe width="80%" height="700" src='https://dbdiagram.io/embed/6487e789722eb77494da0e29' frameBorder="0"> </iframe>

The `Avatar` table has been added, which includes a foreign key to the `User` table. The `Shared_Mindmaps` table has been added to handle sharing of mind maps between users. Each record in this table represents a specific mind map shared with a specific user. Please note that this is still a high-level diagram and the specifics might vary depending on the detailed requirements of your application.

## advanced ER

**Introduction**

manage user roles, actions, password reset procedures, email templates, and notifications. Here's the updated ER diagram:

**Mermaid ER Diagram**

```mermaid
erDiagram

    USERS ||--|| EMAIL_TEMPLATES : "created_by"
    USERS ||--|| TOKEN_BLACK_LIST : "user_id"
    USERS ||--|| NODES : "created_by"
    USERS ||--|| AVATARS : "user_id"
    USERS ||--|| USER_ROLES : "user_id"
    USERS ||--|| ACTION_LOGS : "user_id"
    USERS ||--|| PASSWORD_RESETS : "user_id"
    USERS ||--|| NOTIFICATIONS : "user_id"

    INSTRUCTION_TYPES ||--|| DIAGRAM_INSTRUCTIONS : "instruction_types_id"
    INSTRUCTION_TYPES ||--|| JOBS : "instruction_types_id"
    INSTRUCTION_TYPES ||--|| NODE_INSTRUCTIONS : "instruction_types_id"

    DIAGRAMS ||--|| JOBS : "diagram_id"
    DIAGRAMS ||--|| EDGES : "diagram_id"
    DIAGRAMS ||--|| NODES : "diagram_id"
    DIAGRAMS ||--|| DIAGRAM_INSTRUCTIONS : "diagram_id"

    NODES ||--|| DIAGRAM_INSTRUCTIONS : "node_id"
    NODES ||--|| NODE_EDGE : "node_id"
    NODES ||--|| NODE_INSTRUCTIONS : "node_id"

    EDGES ||--|| NODE_EDGE : "edge_id"

    USERS {
        id serial
        username varchar
        email varchar
        password varchar
        jwt varchar
        created_at timestamp
        updated_at timestamp
    }
    TOKEN_BLACK_LIST {
        id serial
        user_id integer
        token_id varchar
        blacklisted_at timestamp
        created_at timestamp
        updated_at timestamp
    }
    DIAGRAMS {
        id serial
        diagram_data jsonb
        name varchar
        slug varchar
        description varchar
        created_at timestamp
        updated_at timestamp
        created_by integer
        sharing_settings varchar
    }
    NODES {
        id serial
        diagram_id integer
        position jsonb
        type varchar
        data jsonb
        created_at timestamp
        updated_at timestamp
        created_by integer
    }
    EDGES {
        id serial
        diagram_id integer
        source integer
        target integer
        animated boolean
        label varchar
    }
    NODE_EDGE {
        id serial
        edge_id integer
        node_id integer
        created_at timestamp
        updated_at timestamp
    }
    NODE_INSTRUCTIONS {
        id serial
        node_id integer
        instruction_types_id integer
        created_at timestamp
        updated_at timestamp
        created_by text
    }
    INSTRUCTION_TYPES {
        id serial
        name varchar
        slug varchar
        description varchar
        parameters varchar
        priority integer
        max_retry integer
        created_at timestamp
        updated_at timestamp
        created_by integer
    }
    DIAGRAM_INSTRUCTIONS {
        id serial
        diagram_id integer
        instruction_types_id integer 
        node_id integer
        instruction_order integer
        parameters jsonb
        created_at timestamp
        updated_at timestamp
    }
    JOBS {
        id serial
        instruction_types_id integer
        diagram_id integer
        node_id integer
        scheduled_time timestamp
        retry_count integer
        trigger_time timestamp
        created_at timestamp
        updated_at timestamp
    }
    AVATARS {
        id serial
        user_id integer
        image_url varchar
        created_at timestamp
        updated_at timestamp
    }
    USER_ROLES {
        id serial
        user_id integer
        role varchar
    }
    ACTION_LOGS {
        id serial
        user_id integer
        action varchar
        timestamp timestamp
    }
    PASSWORD_RESETS {
        id serial
        user_id integer
        reset_token varchar
        expiry_time timestamp
    }
    EMAIL_TEMPLATES {
        id serial
        template_name varchar
        template_content varchar
        created_at timestamp
        updated_at timestamp
        created_by integer
    }
    NOTIFICATIONS {
        id serial
        user_id integer
        content varchar
        created_at timestamp
        is_read boolean
    }

```

**Entities (Tables) Description**

1. `User`: This entity represents the users of the system. The attributes include `user_id`, `email`, `password`, `jwt` (JSON Web Token for authentication), `created_at`, and `updated_at`.
2. `Diagram`: This entity represents the diagrams created by users. It has attributes like `id`, `diagram_data`, `name`, `description`, `created_at`, `updated_at`, and `created_by`.
3. `Instruction`: This entity stores the instructions associated with each diagram. The attributes include `id`, `diagram_id`, `node_id`, `type`, `name`, `description`, `parameters`, `priority`, `scheduled_time`, `retry_count`, `max_retry`, `created_at`, and `updated_at`.
4. `Job`: This entity represents the jobs created for delayed or scheduled instructions. It has a `job_id`, an `instruction_id` to link the job to a specific instruction, a `trigger_time` which indicates when the job should be executed, and timestamps `created_at` and `updated_at`.
5. `Diagram_Instruction`: This junction table that represents the many-to-many relationship between the `Diagram` and `Instruction` tables. It contains `diagram_id`, `node_id`, `node_type`, and `parameters` as attributes, as well as `created_at` and `updated_at`.
6. The `Avatar` table has been added, which includes a foreign key to the `User` table.
7. The `Shared_Mindmaps` table has been added to handle sharing of mind maps between users. Each record in this table represents a specific mind map shared with a specific user. Please note that this is still a high-level diagram and the specifics might vary depending on the detailed requirements of your application.
8. `User_Role`: This table holds the information about the different roles a user can have. It includes `user_id` (foreign key) and `role` (role of the user, such as admin, guest, registered user).
9. `Action_Log`: This table stores every action performed by the users. It includes `id` (primary key), `user_id` (foreign key), `action` (action performed), and `timestamp` (time of the action).
10. `Password_Reset`: This table is used for password reset functionality. It includes `id` (primary key), `user_id` (foreign key), `reset_token` (unique reset token), and `expiry_time` (expiration time of the reset token).
11. `Email_Template`: This table stores the different types of email templates. It includes `id` (primary key), `template_name` (name of the template), and `template_content` (content of the template).
12. `Notification`: This table manages

 the notifications sent to the users. It includes `id` (primary key), `user_id` (foreign key), `content` (content of the notification), `created_at` (creation time), and `is_read` (indicates whether the notification has been read).

This expanded ER diagram should now cover all the needs of your application, including the added functionalities. Remember, the ER diagram may need further refinements depending on your specific use cases and data requirements.



```sql
CREATE TABLE "users" (
  "id" SERIAL PRIMARY KEY,
  "username" varchar UNIQUE,
  "email" varchar UNIQUE,
  "password" varchar,
  "jwt" varchar,
  "created_at" timestamp,
  "updated_at" timestamp
);

CREATE TABLE "token_black_list" (
  "id" SERIAL PRIMARY KEY,
  "user_id" integer,
  "token_id" varchar(255),
  "blacklisted_at" timestamp,
  "created_at" timestamp,
  "updated_at" timestamp
);

CREATE TABLE "diagrams" (
  "id" SERIAL PRIMARY KEY,
  "diagram_data" jsonb,
  "name" varchar,
  "slug" varchar UNIQUE,
  "description" varchar,
  "created_at" timestamp,
  "updated_at" timestamp,
  "created_by" integer,
  "sharing_settings" varchar
);

CREATE TABLE "nodes" (
  "id" SERIAL PRIMARY KEY,
  "diagram_id" integer,
  "position" jsonb,
  "type" varchar,
  "data" jsonb,
  "created_at" timestamp,
  "updated_at" timestamp,
  "created_by" integer
);

CREATE TABLE "edges" (
  "id" SERIAL PRIMARY KEY,
  "diagram_id" integer,
  "source" integer,
  "target" integer,
  "animated" boolean,
  "label" varchar
);

CREATE TABLE "node_edge" (
  "id" SERIAL PRIMARY KEY,
  "edge_id" integer,
  "node_id" integer,
  "created_at" timestamp,
  "updated_at" timestamp
);

CREATE TABLE "node_instructions" (
  "id" SERIAL PRIMARY KEY,
  "node_id" integer,
  "instruction_types_id" integer,
  "created_at" timestamp,
  "updated_at" timestamp,
  "created_by" text
);

CREATE TABLE "instruction_types" (
  "id" SERIAL PRIMARY KEY,
  "name" varchar,
  "slug" varchar UNIQUE,
  "description" varchar,
  "parameters" varchar,
  "priority" integer,
  "max_retry" integer,
  "created_at" timestamp,
  "updated_at" timestamp,
  "created_by" integer
);

CREATE TABLE "diagram_instructions" (
  "id" SERIAL PRIMARY KEY,
  "diagram_id" integer,
  "instruction_types_id" integer,
  "node_id" integer,
  "instruction_order" integer,
  "parameters" varchar,
  "created_at" timestamp,
  "updated_at" timestamp
);

CREATE TABLE "jobs" (
  "id" SERIAL PRIMARY KEY,
  "instruction_types_id" integer,
  "diagram_id" integer,
  "node_id" integer,
  "scheduled_time" timestamp,
  "retry_count" integer,
  "trigger_time" timestamp,
  "created_at" timestamp,
  "updated_at" timestamp
);

CREATE TABLE "avatars" (
  "id" SERIAL PRIMARY KEY,
  "user_id" integer,
  "image_url" varchar,
  "created_at" timestamp,
  "updated_at" timestamp
);

CREATE TABLE "user_roles" (
  "id" SERIAL PRIMARY KEY,
  "user_id" integer,
  "role" varchar
);

CREATE TABLE "action_logs" (
  "id" SERIAL PRIMARY KEY,
  "user_id" integer,
  "action" varchar,
  "timestamp" timestamp
);

CREATE TABLE "password_resets" (
  "id" SERIAL PRIMARY KEY,
  "user_id" integer,
  "reset_token" varchar,
  "expiry_time" timestamp
);

CREATE TABLE "email_templates" (
  "id" SERIAL PRIMARY KEY,
  "template_name" varchar,
  "template_content" varchar,
  "created_at" timestamp,
  "updated_at" timestamp,
  "created_by" integer
);

CREATE TABLE "notifications" (
  "id" SERIAL PRIMARY KEY,
  "user_id" integer,
  "content" varchar,
  "created_at" timestamp,
  "is_read" boolean
);

ALTER TABLE "diagram_instructions" ADD FOREIGN KEY ("instruction_types_id") REFERENCES "instruction_types" ("id");

ALTER TABLE "diagrams" ADD FOREIGN KEY ("created_by") REFERENCES "users" ("id");

ALTER TABLE "instruction_types" ADD FOREIGN KEY ("created_by") REFERENCES "users" ("id");

ALTER TABLE "jobs" ADD FOREIGN KEY ("instruction_types_id") REFERENCES "instruction_types" ("id");

ALTER TABLE "jobs" ADD FOREIGN KEY ("diagram_id") REFERENCES "diagrams" ("id");

ALTER TABLE "avatars" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("id");

ALTER TABLE "user_roles" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("id");

ALTER TABLE "action_logs" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("id");

ALTER TABLE "password_resets" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("id");

ALTER TABLE "notifications" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("id");

ALTER TABLE "node_instructions" ADD FOREIGN KEY ("node_id") REFERENCES "nodes" ("id");

ALTER TABLE "node_instructions" ADD FOREIGN KEY ("instruction_types_id") REFERENCES "instruction_types" ("id");

ALTER TABLE "node_edge" ADD FOREIGN KEY ("node_id") REFERENCES "nodes" ("id");

ALTER TABLE "edges" ADD FOREIGN KEY ("diagram_id") REFERENCES "diagrams" ("id");

ALTER TABLE "node_edge" ADD FOREIGN KEY ("edge_id") REFERENCES "edges" ("id");

ALTER TABLE "nodes" ADD FOREIGN KEY ("diagram_id") REFERENCES "diagrams" ("id");

ALTER TABLE "email_templates" ADD FOREIGN KEY ("created_by") REFERENCES "users" ("id");

ALTER TABLE "token_black_list" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("id");

ALTER TABLE "diagram_instructions" ADD FOREIGN KEY ("diagram_id") REFERENCES "diagrams" ("id");

ALTER TABLE "diagram_instructions" ADD FOREIGN KEY ("node_id") REFERENCES "nodes" ("id");

ALTER TABLE "nodes" ADD FOREIGN KEY ("created_by") REFERENCES "users" ("id");


```